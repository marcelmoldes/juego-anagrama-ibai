---
import "../styles/global.css";
import fondoAnagrama from "../assets/fondo-anagrama.jpg";
---

<div class="relative isolate bg-white dark:bg-gray-900">
  <div class="mx-auto grid max-w-7xl grid-cols-1 lg:grid-cols-2">

    <!-- SECCI√ìN IZQUIERDA -->
    <div
      class="relative px-6 pb-20 pt-24 sm:pt-32 lg:static lg:px-8 lg:py-48 bg-cover bg-center"
      style={`background-image: url(${fondoAnagrama});`}
    >
      <div class="mx-auto max-w-xl lg:mx-0 lg:max-w-lg relative z-10">
        <h2 class="text-pretty text-4xl font-semibold tracking-tight text-gray-900 sm:text-5xl dark:text-white">
          Bienvenido al Anagrama de Ibai
        </h2>
        <p class="mt-6 text-lg/8 text-gray-600 dark:text-gray-400">
          En esta prueba se evaluar√° tu capacidad para encontrar palabras dentro de un conjunto de letras desordenadas. 
          Para adivinar la frase tendr√°s que reproducir el audio que te ha enviado Ibai.
        </p>

        <div class="mt-6 flex gap-4">
          <button
            id="btn-reglas"
            type="button"
            class="rounded-md bg-indigo-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            Reglas del juego
          </button>

          <button
            id="btn-empezar"
            type="button"
            class="rounded-md bg-green-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-green-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-green-600 transition-all disabled:bg-gray-400 disabled:cursor-not-allowed"
          >
            Empezar el juego
          </button>
        </div>
      </div>
    </div>

    <!-- SECCI√ìN DERECHA: CHAT -->
    <div
      id="chat-container"
      class="max-w-md mx-auto mt-10 bg-gray-100 rounded-xl shadow-lg p-4 flex flex-col space-y-4 h-[600px] overflow-y-auto"
    >
  <!-- Banner estilo WhatsApp -->
  <!-- Header del chat -->
  <div class="flex items-center bg-green-500 text-white px-4 py-3">
    <img
      src="https://i.pravatar.cc/40?img=12"
      alt="Foto de contacto"
      class="w-10 h-10 rounded-full mr-3"
    />
    <div>
      <h3 class="font-semibold">Ibai</h3>
      <p class="text-sm text-green-200">En l√≠nea</p>
    </div>
  </div>
      <div class="mt-auto flex items-center space-x-2 bg-gray-200 p-2 rounded-lg">
        <input
          id="input-msg"
          type="text"
          placeholder="Escribe un mensaje..."
          class="flex-1 rounded-full px-4 py-2 outline-none bg-white"
        />
        <button id="btn-enviar" class="bg-green-500 text-white px-4 py-2 rounded-full">
          Enviar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL DE REGLAS -->
<div
  id="modal-reglas"
  class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50"
>
  <div class="bg-white dark:bg-gray-800 rounded-xl shadow-lg p-6 max-w-lg text-gray-800 dark:text-white relative">
    <h3 class="text-xl font-semibold mb-2">Reglas del juego</h3>
    <p class="mb-4 text-sm leading-relaxed">
      1Ô∏è‚É£ Reordena las letras para descubrir la frase secreta.<br />
      2Ô∏è‚É£ Puedes escuchar la pista de Ibai si lo necesitas.<br />
      3Ô∏è‚É£ Solo tienes una oportunidad por d√≠a.<br />
      ¬°Buena suerte!
    </p>
    <button
      id="cerrar-modal"
      class="absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white rounded-full px-3 py-1"
    >
      ‚úï
    </button>
  </div>
</div>

<script>
import audioIbai from "../assets/ibaiaudio.mp3";

const btnEmpezar = document.getElementById("btn-empezar");
const btnReglas = document.getElementById("btn-reglas");
const btnCerrar = document.getElementById("cerrar-modal");
const chatContainer = document.getElementById("chat-container");
const inputContainer = chatContainer.querySelector(".mt-auto");
const inputMsg = document.getElementById("input-msg");
const btnEnviar = document.getElementById("btn-enviar");

const mensajeIbai = "¬°Hola! Aqu√≠ tienes la pista para adivinar la frase secreta. ¬°Buena suerte!";
const solucion = "CIRQUE DU SOL";

// Funci√≥n para enviar mensaje con audio
function enviarMensajeAudio(texto, rutaAudio) {
  const msg = document.createElement("div");
  msg.className = "flex flex-col items-start space-y-2";

  const textoDiv = document.createElement("div");
  textoDiv.className = "bg-white p-3 rounded-lg shadow text-gray-900 max-w-xs";
  textoDiv.textContent = `üé§ Ibai: ${texto}`;
  msg.appendChild(textoDiv);

  if (rutaAudio) {
    const audioElement = document.createElement("audio");
    audioElement.controls = true;
    audioElement.className = "w-full mt-1 rounded";
    audioElement.src = rutaAudio;
    msg.appendChild(audioElement);

    audioElement.addEventListener("ended", () => iniciarJuego(msg, audioElement));
  }

  if (inputContainer) chatContainer.insertBefore(msg, inputContainer);
  else chatContainer.appendChild(msg);

  chatContainer.scrollTop = chatContainer.scrollHeight;
  return msg;
}

// Modal reglas
btnReglas.addEventListener("click", () => { if (!btnReglas.disabled) modalReglas.classList.remove("hidden"); });
btnCerrar.addEventListener("click", () => modalReglas.classList.add("hidden"));

// Validaci√≥n input
function validarRespuestaInput() {
  const respuesta = inputMsg.value.trim().toUpperCase().replace(/\s/g,'');
  const solucionNormalizada = solucion.replace(/\s/g,'').toUpperCase();
  if(respuesta === solucionNormalizada){
    alert("‚úÖ ¬°Correcto! Has completado la frase.");
    inputMsg.disabled = true;
    btnEnviar.disabled = true;
  } else {
    alert("‚ùå Incorrecto, int√©ntalo de nuevo.");
    inputMsg.value = "";
  }
}
btnEnviar.addEventListener("click", validarRespuestaInput);
inputMsg.addEventListener("keydown", (e)=>{if(e.key==="Enter"){e.preventDefault(); validarRespuestaInput();}});

// Funci√≥n que inicia las letras despu√©s del audio
function iniciarJuego(msg, audioElement){
  audioElement.controls = false;
  audioElement.style.opacity = "0.5";
  audioElement.disabled = true;

  const frase = solucion;
  const letrasDesordenadas = frase.replace(/\s/g,'').split('').sort(() => Math.random()-0.5);

  const contenedorLetras = document.createElement("div");
  contenedorLetras.id = "letras-container";
  contenedorLetras.className = "flex flex-wrap gap-2 mb-4";

  const contenedorFrase = document.createElement("div");
  contenedorFrase.id = "frase-usuario";
  contenedorFrase.className = "flex flex-wrap gap-2 mb-4 min-h-[2rem] border border-gray-300 p-2 rounded";

  msg.appendChild(contenedorFrase);

  // Contador
  let tiempo = 0;
  const contadorDiv = document.createElement("div");
  contadorDiv.className = "text-lg font-bold mb-2";
  msg.appendChild(contadorDiv);
  setInterval(()=>{tiempo++; contadorDiv.textContent=`Tiempo: ${tiempo} s`},1000);

  // Letras
  const letrasUsadas = {};
  letrasDesordenadas.forEach(letra=>{
    letrasUsadas[letra] = (letrasUsadas[letra]||0)+1;
  });

  letrasDesordenadas.forEach(letra=>{
    const letraDiv = document.createElement("button");
    letraDiv.textContent = letra;
    letraDiv.dataset.letra = letra;
    letraDiv.className = "bg-gray-300 rounded p-2 w-10 h-10 text-center font-bold hover:bg-gray-400";

    letraDiv.addEventListener("click", ()=>{
      const contador = letrasUsadas[letra];
      if(!contador || contador <= 0) return;

      const span = document.createElement("span");
      span.textContent = letra;
      span.className = "font-bold text-lg";
      contenedorFrase.appendChild(span);

      letrasUsadas[letra]--;
      if(letrasUsadas[letra]<=0) letraDiv.disabled = true;

      comprobarFrase(contenedorFrase);
    });

    contenedorLetras.appendChild(letraDiv);
  });

  msg.appendChild(contenedorLetras);
}

// Funci√≥n comprobar frase clicando letras
function comprobarFrase(contenedorFrase){
  const fraseUsuario = Array.from(contenedorFrase.children).map(span=>span.textContent).join('');
  const usuarioNormalizado = fraseUsuario.replace(/\s/g,'').toUpperCase();
  const solucionNormalizada = solucion.replace(/\s/g,'').toUpperCase();

  if(usuarioNormalizado.length === solucionNormalizada.length){
    if(usuarioNormalizado === solucionNormalizada){
      alert("‚úÖ ¬°Correcto! Has completado la frase.");
    } else {
      contenedorFrase.classList.add("animate-shake", "border-red-500");
      setTimeout(()=>{
        contenedorFrase.classList.remove("animate-shake", "border-red-500");
        contenedorFrase.innerHTML = "";

        const botones = contenedorFrase.parentElement.querySelectorAll("#letras-container button");
        botones.forEach(b=>{
          const letra = b.dataset.letra;
          b.disabled = false;
        });
      },800);
    }
  }
}

// Bot√≥n empezar
btnEmpezar.addEventListener("click", ()=>{
  if(btnEmpezar.disabled) return;
  btnEmpezar.disabled = true;
  btnReglas.disabled = true;
  enviarMensajeAudio(mensajeIbai, audioIbai);
});
</script>

<style>
@keyframes shake {
  0%,100%{transform:translateX(0);}
  20%,60%{transform:translateX(-5px);}
  40%,80%{transform:translateX(5px);}
}
.animate-shake {animation: shake 0.4s ease;}
</style>

<style>
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-5px); }
  40%, 80% { transform: translateX(5px); }
}
.animate-shake {
  animation: shake 0.4s ease;
}
</style>
